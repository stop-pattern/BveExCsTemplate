name: Create release
on:
   workflow_dispatch:
   pull_request:
     branches:
       - main
     types:
       - closed

jobs:
  build:
    name: Generate dll
    runs-on: windows-latest
    outputs:
      name: ${{ steps.version.outputs.name }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1
      - name: Setup .NET
        uses: actions/setup-dotnet@v5.0.1
      - name: Restore nuget packages
        run: dotnet restore BveExCsTemplate.sln --locked-mode
      - name: Build sln
        run: dotnet publish .\BveExCsTemplate.sln --configuration Release --no-restore /p:platform="Any CPU" /p:OutputPath="./out/"
      - name: Collect artifact
        run: |
          mkdir plugins/
          # 各プロジェクトディレクトリからプロジェクト名と同じDLLのみを収集
          find . -maxdepth 2 -name "*.csproj" -type f | while read csproj; do
            proj_dir=$(dirname "$csproj")
            proj_name=$(basename "$csproj" .csproj)
            dll_path="${proj_dir}/out/publish/${proj_name}.dll"
            if [ -f "$dll_path" ]; then
              echo "Collecting: $dll_path"
              cp "$dll_path" ./plugins/
            else
              echo "Warning: $dll_path not found"
            fi
          done
          # 収集結果を表示
          echo "Collected DLLs:"
          ls -lh ./plugins/
        shell: bash
      - name: Check assembly version
        id: version
        run: |
          $files = Get-ChildItem plugins/ -Filter "*.dll" -File
          if ($files.Count -eq 0) {
            Write-Error "No DLL files found in plugins/"
            exit 1
          }
          
          Write-Output "=== DLL Version Check ==="
          $firstVersion = $null
          foreach ($file in $files) {
            $ver = (Get-Item $file.FullName).VersionInfo.FileVersion
            Write-Output "$($file.Name): v$ver"
            if ($null -eq $firstVersion) {
              $firstVersion = $ver
              "version=v$ver" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            }
          }
        shell: pwsh
      - name: Upload artifact
        uses: actions/upload-artifact@v6.0.0
        with:
          name: plugins
          path: ./plugins/

  release:
    name: Create release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1
      - name: Download artifact
        uses: actions/download-artifact@v6.0.0
        with:
          name: plugins
          path: ./plugins/
      - name: Create tag
        uses: rickstaa/action-create-tag@v1.7.2
        id: "tag_create"
        with:
          tag: "${{needs.build.outputs.version}}"
          tag_exists_error: true
          message: "Created tag ${{needs.build.outputs.version}}"
      - name: Create Release Draft and Upload Release Asset
        uses: softprops/action-gh-release@v2.5.0
        with:
           tag_name: ${{needs.build.outputs.version}}
           name: Release ${{needs.build.outputs.version}}
           body: TODO New Release.
           draft: true
           prerelease: false
           files: |
             ./plugins/*.dll
             LICENSE
